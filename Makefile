# High level build commands for symforce

BUILD_DIR=build

PYTHON ?= /usr/bin/env python3

CPP_FORMAT=clang-format

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

# Build documentation, run tests, measure coverage, show in browser
all: clean docs coverage coverage_open docs_open

# Install all needed packages
all_reqs: reqs test_reqs docs_reqs

FIND_CPP_FILES_TO_FORMAT=find . \
	-not -path "*/lcmtypes/*" \
	-and -not -path "./third_party/*" \
	-and -not -path "./build/*" \
	-and -not -path "./.eggs/*" \
	-and -not -path "./symforce/benchmarks/matrix_multiplication/gen/*" \
	-regextype posix-extended -regex ".*\.(h|cc|tcc)"

# Format using black and clang-format
BLACK_CMD=$(PYTHON) -m black --line-length 100 . --exclude "third_party/.*|build/.*|\.eggs/.*"
format:
	$(BLACK_CMD)
	$(FIND_CPP_FILES_TO_FORMAT) | xargs $(CPP_FORMAT) -i

# Check formatting using black and clang-format - print diff, do not modify files
check_format:
	$(BLACK_CMD) --check --diff
	$(FIND_CPP_FILES_TO_FORMAT) | xargs $(CPP_FORMAT) --dry-run -Werror

# Check type hints using mypy
# NOTE(aaron): mypy does not recurse through directories unless they're packages, so we run `find`.
# See https://github.com/python/mypy/issues/8548
# We don't need to run find on `symforce` because we know the whole thing is a package
MYPY_COMMAND=$(PYTHON) -m mypy
SYMFORCE_LCMTYPES_DIR ?= build/lcmtypes/python2.7
check_types:
	export SYMFORCE_LCMTYPES_DIR=$(SYMFORCE_LCMTYPES_DIR); \
	$(MYPY_COMMAND) symforce $(shell find . \
		\( -path ./symforce \
		-o -path ./third_party \
		-o -path ./build \
		-o -path ./.eggs \
		-o -path ./gen/python/setup.py \
		-o -path ./test/symforce_function_codegen_test_data \
		\) -prune -o -name "*.py" -print) \
		--exclude "symforce/examples/.*/gen/python2\.7/lcmtypes"
	$(MYPY_COMMAND) $(shell find test/symforce_function_codegen_test_data/sympy \
		-path "*/lcmtypes" -prune -false \
		-o -name "*.py")
	$(MYPY_COMMAND) $(shell find test/symforce_function_codegen_test_data/symengine \
		-path "*/lcmtypes" -prune -false \
		-o -name "*.py")

# Run pylint on the symforce package
# TODO(aaron): Also run on other python code in symforce.  Generated code will require a different
# config since it is py6 and contains a lot of duplicate code
pylint:
	$(PYTHON) -m pylint symforce

# Lint check for formatting and type hints
# This needs pass before any merge.
lint: check_types check_format pylint

# Clean all artifacts
clean: docs_clean coverage_clean
	rm -rf $(BUILD_DIR)

.PHONY: all reqs format check_format check_types lint clean

# -----------------------------------------------------------------------------
# Tests
# -----------------------------------------------------------------------------

TEST_ENV=SYMFORCE_LOGLEVEL=WARNING
TEST_CMD=-m unittest discover -s test/ -p *_test.py -v

# Python files which generate code
GEN_FILES=test/*codegen*.py

test_symengine:
	$(TEST_ENV) SYMFORCE_BACKEND=symengine $(PYTHON) $(TEST_CMD)

test_sympy:
	$(TEST_ENV) SYMFORCE_BACKEND=sympy $(PYTHON) $(TEST_CMD)

test: test_symengine test_sympy

# Generic target to run a SymEngine codegen test with --update
update_%:
	$(TEST_ENV) SYMFORCE_BACKEND=symengine $(PYTHON) test/$*.py --update

# All SymForce codegen tests, formatted as update_my_codegen_test targets
GEN_FILES_UPDATE_TARGETS=$(shell \
	find test -name "*_codegen_test.py" \
	| sed 's/test\/\(\w\+\).py/update_\1/g')
# Target to update all code generated by SymEngine codegen tests
test_update: $(GEN_FILES_UPDATE_TARGETS)

# Generic target to run a SymPy codegen test with --update --run_slow_tests
sympy_update_%:
	$(TEST_ENV) SYMFORCE_BACKEND=sympy $(PYTHON) test/$*.py --update --run_slow_tests

# All SymForce codegen tests, formatted as sympy_update_my_codegen_test targets
GEN_FILES_SYMPY_UPDATE_TARGETS=$(shell \
	find test -name "*_codegen_test.py" \
	| sed 's/test\/\(\w\+\).py/sympy_update_\1/g')
# Target to update all code generated by SymPy codegen tests
test_update_sympy: $(GEN_FILES_SYMPY_UPDATE_TARGETS)

# Target to regenerate all code
test_update_all: test_update test_update_sympy

.PHONY: test_reqs test_symengine test_sympy test update_% sympy_update_% test_update test_update_all

# -----------------------------------------------------------------------------
# Test coverage
# -----------------------------------------------------------------------------
COVERAGE_DIR=$(BUILD_DIR)/coverage

coverage_clean:
	rm -rf $(COVERAGE_DIR)

coverage_run:
	$(TEST_ENV) $(PYTHON) -m coverage run --source=symforce,gen $(TEST_CMD)

coverage_html:
	$(PYTHON) -m coverage html -d $(COVERAGE_DIR) && echo "Coverage report at $(COVERAGE_DIR)/index.html"

coverage: coverage_clean coverage_run coverage_html

coverage_open: coverage
	open $(COVERAGE_DIR)/index.html

.PHONY: coverage_clean coverage_run coverage_html coverage coverage_open

# -----------------------------------------------------------------------------
# Documentation
# -----------------------------------------------------------------------------
DOCS_DIR=$(BUILD_DIR)/docs

docs_clean:
	rm -rf $(DOCS_DIR) docs/api docs/api-cpp docs/api-gen-cpp docs/api-gen-py \
		$(BUILD_DIR)/doxygen-cpp $(BUILD_DIR)/doxygen-gen-cpp

docs_apidoc:
	mkdir -p $(BUILD_DIR)
	sphinx-apidoc --separate --module-first -o docs/api ./symforce
	sphinx-apidoc --separate --module-first -o docs/api-gen-py ./gen/python
	doxygen docs/Doxyfile-cpp
	doxygen docs/Doxyfile-gen-cpp
	$(PYTHON) -m breathe.apidoc -o docs/api-cpp --project api-cpp $(BUILD_DIR)/doxygen-cpp/xml
	$(PYTHON) -m breathe.apidoc -o docs/api-gen-cpp --project api-gen-cpp $(BUILD_DIR)/doxygen-gen-cpp/xml
# The generated symforce.cc_sym.rst file says to generate docs for symforce.cc_sym. However, that file
# only rexports cc_sym, and consequently the actual contents of cc_sym are not documented. We replace
# symforce.cc_sym.rst with a copy which is the same except it says to generate docs for cc_sym instead.
	rm docs/api/symforce.cc_sym.rst
	cp docs/symforce.cc_sym.rst docs/api/symforce.cc_sym.rst

PY_EXTENSION_MODULE_PATH?=$(BUILD_DIR)/pybind

docs_html: docs_apidoc
	export PYTHONPATH=$(PY_EXTENSION_MODULE_PATH):$(PYTHONPATH); \
	SYMFORCE_LOGLEVEL=WARNING $(PYTHON) -m sphinx -b html docs $(DOCS_DIR) -j auto
	mkdir $(DOCS_DIR)/docs
	ln -s ../_static $(DOCS_DIR)/docs/static

docs: docs_clean docs_html

docs_open: docs
	xdg-open $(DOCS_DIR)/index.html

.PHONY: docs_reqs docs_clean docs_apidoc docs_html docs docs_open
