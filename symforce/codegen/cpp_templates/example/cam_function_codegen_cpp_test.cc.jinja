/**
 * Tests for generated functions that accept C++ camera types as arguments. Mostly testing that
 * everything compiles.
 */

#include <Eigen/Dense>
#include <fmt/ostream.h>
#include <spdlog/spdlog.h>

// TODO(nathan): We just test linear camera for now, but could/should test other types in the future
#include <sym/linear_camera_cal.h>
#include <symforce/cam_function_codegen_test/pixel_to_ray_and_back.h>

#include "catch.hpp"

TEMPLATE_TEST_CASE("Test generated function", "[cam_function]", sym::LinearCameraCal<double>,
                   sym::LinearCameraCal<float>) {
  using T = TestType;
  using Scalar = typename T::Scalar;
  Scalar epsilon = 1e-6; // For preventing degenerate numerical cases (e.g. division by zero)
  Scalar tolerance = 10.0 * epsilon; // For assessing approximate equality

  Eigen::Matrix<Scalar, sym::StorageOps<T>::StorageDim(), 1> data;
  std::mt19937 gen(42);
  std::uniform_real_distribution<Scalar> cam_dist(100.0, 500.0);
  for (int i = 0; i < sym::StorageOps<T>::StorageDim(); i++) {
    data[i] = cam_dist(gen);
  }
  T cam(data);
  spdlog::info("*** Testing generated function with {} ***", cam);

  int is_valid;

  Eigen::Matrix<Scalar, 2, 1> pixel;
  pixel << 2.0 * cam_dist(gen), 2.0 * cam_dist(gen);
  Eigen::Matrix<Scalar, 2, 1> pixel_reprojected =
      cam_function_codegen_test::PixelToRayAndBack<Scalar>(pixel, cam, epsilon);
  CHECK(pixel.isApprox(pixel_reprojected, epsilon));
}
